---
- name: Setup new server
  become: yes
  # Excute some tasks before anything else happens to make
  # sure all packages we may need later are already there.
  pre_tasks:
    - name: Install standard packages on Debian systems
      include_tasks: /etc/ansible/tasks/pb_inst_std_pkg_deb.yml
      when: ansible_facts['os_family'] == "Debian"
    - name: Install standard packages on RedHat based systems
      include_tasks: /etc/ansible/tasks/pb_inst_std_pkg_rhel.yml
      when: ansible_facts['os_family'] == "RedHat"
  # Add the role that will install the Zabbix agent on the
  # new system
  roles:
    - role: dj-wasabi.zabbix-agent
      agent_server: raspi.sport-touring.eu
      agent_serveractive: raspi.sport-touring.eu
      when: not check.stat.exists
  # Now we can execute the regular tasks we need to perform
  # to finalize the setup of a new system.
  tasks:
    - name: Modifying the hosts file
      include_tasks: /etc/ansible/tasks/pb_add_raspi_hosts.yml
    - name: Initialize profile for standard users
      include_tasks: /etc/ansible/tasks/pb_init_profile.yml
    - name: Set /setup_complete to avoid running these again
      file:
        path: "/setup_complete"
        state: touch