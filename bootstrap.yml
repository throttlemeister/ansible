---
#
# We need to have the user throttlemeister present on the system, together with sudo and the right shell
# to be able to log in to the system and do the rest of the setup.
#
- name: Let's bootstrap a new server and get it ready for standard deployment
  #hosts: "{{ bootstrap_host | default('bootstrap')}}"
  hosts: "{{ bootstrap_host }}"
  tasks:
    - name: We need to make sure fish is installed or else we will not be able to login with the user we will create after this
      action: >
        {{ ansible_pkg_mgr }} name=fish,sudo state=present update_cache=yes
    - name: We need to create the user throttlemeister
      when: ansible_os_family == "RedHat"
      user:
        name: throttlemeister
        groups:
          - users
          - sudo
        state: present
        shell: /usr/bin/fish
        system: false
        createhome: true
        home: /home/throttlemeister
    - name: We need to create the user throttlemeister
      when: ansible_os_family == "Debian"
      user:
        name: throttlemeister
        groups:
          - users
          - sudo
        state: present
        shell: /usr/bin/fish
        system: false
        createhome: true
        home: /home/throttlemeister
    - name: Now we need to set up the user profile, because we want to be able to login and we need the SSH keys
      unarchive:
        src: /home/throttlemeister/profile_proper.tar.gz
        dest: /home/throttlemeister
    - name: Upload and extract profile for root
      unarchive:
        src: /home/throttlemeister/profile_proper.tar.gz
        dest: /root
        owner: root
        group: root
  # We also need to add the Zabbix agent so we can monitor the host, so let's do that now.
  roles:
    - role: community.zabbix.zabbix_agent
      zabbix_agent_server: raspi.sport-touring.eu
      zabbix_agent_serveractive: raspi.sport-touring.eu
      zabbix_url: http://raspi.sport-touring.eu/zabbix
      zabbix_api_create_hosts: true
      zabbix_api_use: true
      zabbix_api_user: Admin
      zabbix_api_pass: kd!s5q%!s4Nf3LsE$rQQijWHg
      zabbix_create_host: present
      zabbix_host_groups:
        - Discovered hosts
      zabbix_link_templates:
        - Linux by Zabbix agent
