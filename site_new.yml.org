---
- hosts: redhat
  become: yes
  pre_tasks:
    - name: Check if the server has been setup completely
      stat:
        path: "/setup_complete"
      register: check
    - name: Install epel repository on RedHat Enterprise Linux or Fedora
      when: not check.stat.exists and (ansible_distribution == "RedHat" or ansible_distribution == "Fedora")
      dnf:
        name:
          - https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
    - name: Install epel repository on CentOS
      when: (ansible_distribution == "CentOS" or ansible_distribution == "AlmaLinux") and not check.stat.exists
      dnf:
        name:
          - epel-release
        update_cache: yes
        state: latest
    - name: Install the sport-touring.eu base packages on RedHat based Linux
      when: not check.stat.exists
      dnf: 
        name:
          - cifs-utils
          - hostname
          - qemu-guest-agent
          - wget
          - curl
          - htop
          - mc
          - net-tools
          - nmon
          - bmon
          - ncdu
          - figlet
          - glances
          - perl-Getopt-Long
          - perl-Data-Dumper
        update_cache: yes
        state: latest
    - name: Copy inxi to system
      when: not check.stat.exists
      copy:
        src: /usr/bin/inxi
        dest: /usr/bin/inxi
        owner: root
        group: root
        mode: 0755
    - name: Upload and extract profile for throttlemeister
      when: not check.stat.exists
      unarchive:
        src: /home/throttlemeister/profile_proper.tar.gz
        dest: /home/throttlemeister
    - name: Upload and extract profile for root
      when: not check.stat.exists
      unarchive:
        src: /home/throttlemeister/profile_proper.tar.gz
        dest: /root
        owner: root
        group: root
    - name: Set /setup_complete to avoid running these again
      when: not check.stat.exists
      file:
        path: "/setup_complete"
        state: touch
  tasks:
    - name: Let's make sure all packages are up to date on RedHat based Linux OS
      dnf:
        name: "*"
        state: latest
    - name: Remove dependancies that are no longer needed
      dnf:
        autoremove: yes
    - name: Update inxi to the latest version
      command: /usr/bin/inxi -U

- hosts: debian
  become: yes
  pre_tasks:
    - name: Check if the server has been setup completely
      stat:
        path: "/setup_complete"
      register: check
    - name: Install the sport-touring.eu base packages on Debian based Linux
      when: not check.stat.exists
      apt: 
        name:
          - cifs-utils
          - aptitude
          - hostname
          - qemu-guest-agent
          - wget
          - curl
          - htop
          - mc
          - net-tools
          - nmon
          - bmon
          - ncdu
          - figlet
          - glances
          - perl-Getopt-Long
          - perl-Data-Dumper
        update_cache: yes
        state: latest
    - name: Copy inxi to system
      when: not check.stat.exists
      copy:
        src: /usr/bin/inxi
        dest: /usr/bin/inxi
        owner: root
        group: root
        mode: 0755
    - name: Upload and extract profile for throttlemeister
      when: not check.stat.exists
      unarchive:
        src: /home/throttlemeister/profile_proper.tar.gz
        dest: /home/throttlemeister
    - name: Upload and extract profile for root
      when: not check.stat.exists
      unarchive:
        src: /home/throttlemeister/profile_proper.tar.gz
        dest: /root
        owner: root
        group: root
    - name: Set /setup_complete to avoid running these again
      when: not check.stat.exists
      file:
        path: "/setup_complete"
        state: touch
  tasks:
    - name: Let's make sure all packages are up to date on Debian based Linux OS
      apt:
        name: "*"
        cache_valid_time: 3600
        state: latest
    - name: Clean cache
      apt:
        autoclean: yes
    - name: Remove dependancies that are no longer needed
      apt:
        autoremove: yes

- hosts: nas
  become: yes
  tasks:
  - name: Update bootstrap packages on Synology NAS
    command: "/opt/bin/opkg update && /opt/bin/opkg upgrade"
